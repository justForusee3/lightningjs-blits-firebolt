var ae=Object.defineProperty;var ce=(r,n,e)=>n in r?ae(r,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[n]=e;var a=(r,n,e)=>(ce(r,typeof n!="symbol"?n+"":n,e),e);const P={currentView:Symbol("currentView"),computedKeys:Symbol("computedKeys"),destroy:Symbol("destroy"),index:Symbol("index"),init:Symbol("init"),inputEvents:Symbol("inputEvents"),intervals:Symbol("intervals"),_intervals:Symbol("_intervals"),level:Symbol("level"),methodKeys:Symbol("methodKeys"),originalState:Symbol("originalState"),propKeys:Symbol("propKeys"),ready:Symbol("ready"),renderer:Symbol("renderer"),routes:Symbol("routes"),settings:Symbol("settings"),state:Symbol("state"),stateKeys:Symbol("stateKeys"),textnode:Symbol("textnode"),timeouts:Symbol("timeouts"),_timeouts:Symbol("_timeouts"),type:Symbol("type"),watchers:Symbol("watchers"),watchKeys:Symbol("watchKeys"),wrapper:Symbol("wrapper"),children:Symbol.for("children"),components:Symbol.for("components"),id:Symbol.for("id"),isSlot:Symbol.for("isSlot"),props:Symbol.for("props"),slots:Symbol.for("slots")};function ue(r){const n={alpha:!0,antialias:!1,depth:!1,stencil:!0,desynchronized:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!1};return r.getContext("webgl",n)||r.getContext("experimental-webgl",n)}function y(r,n){if(!r)throw new Error(n||"Assertion failed")}function Ce(r,n,e){const t=Math.trunc(r>>>24),s=Math.trunc(r>>>16&255),i=Math.trunc(r>>>8&255),o=Math.trunc(r&255),h=Math.trunc(n>>>24),c=Math.trunc(n>>>16&255),l=Math.trunc(n>>>8&255),x=Math.trunc(n&255),f=Math.round(h*e+t*(1-e)),m=Math.round(c*e+s*(1-e)),E=Math.round(l*e+i*(1-e)),p=Math.round(x*e+o*(1-e));return(f<<24|m<<16|E<<8|p)>>>0}function Be(r,n){const e=r>>>24,t=r>>>16&255,s=r>>>8&255,i=Math.trunc((r&255)*n);return(e<<24|t<<16|s<<8|i)>>>0}function Le(r,n,e=!1){const t=(r&255)/255*n,s=Math.trunc((r>>>24)*t),i=Math.trunc((r>>>16&255)*t),o=Math.trunc((r>>>8&255)*t),h=Math.trunc(t*255);return e?(h<<24|o<<16|i<<8|s)>>>0:(s<<24|i<<16|o<<8|h)>>>0}function X(r,n){return Object.prototype.hasOwnProperty.call(r,n)}class J{constructor(){a(this,"eventListeners",{})}on(n,e){let t=this.eventListeners[n];t||(t=[]),t.push(e),this.eventListeners[n]=t}off(n,e){const t=this.eventListeners[n];if(!t)return;if(!e){delete this.eventListeners[n];return}const s=t.indexOf(e);s>=0&&t.splice(s,1)}once(n,e){const t=(s,i)=>{this.off(n,t),e(s,i)};this.on(n,t)}emit(n,e){const t=this.eventListeners[n];t&&[...t].forEach(s=>{s(this,e)})}removeAllListeners(){this.eventListeners={}}}const z=r=>r&&!(r&r-1),g=(r,n,e,t)=>{const s=3*r,i=3*(e-r)-s,o=1-s-i,h=3*n,c=3*(t-n)-h,l=1-h-c;return function(x){if(x>=1)return 1;if(x<=0)return 0;let f=.5,m,E,p;for(let _=0;_<20;_++){if(m=f*(f*(f*o+i)+s),p=x-m,p>-1e-8&&p<1e-8)return f*(f*(f*l+c)+h);if(E=f*(f*(3*o)+2*i)+s,E>1e-10&&E<1e-10)break;f+=p/E}let d=0,T=1;for(let _=0;_<20;_++){if(f=.5*(d+T),m=f*(f*(f*o+i)+s),p=x-m,p>-1e-8&&p<1e-8)return f*(f*(f*l+c)+h);p<0?T=f:d=f}}},Oe=r=>{switch(r){case"linear":return function(e){return e};case"ease":return g(.25,.1,.25,1);case"ease-in":return g(.42,0,1,1);case"ease-out":return g(0,0,.58,1);case"ease-in-out":return g(.42,0,.58,1);case"ease-in-sine":return g(.12,0,.39,0);case"ease-out-sine":return g(.12,0,.39,0);case"ease-in-out-sine":return g(.37,0,.63,1);case"ease-in-cubic":return g(.32,0,.67,0);case"ease-out-cubic":return g(.33,1,.68,1);case"ease-in-out-cubic":return g(.65,0,.35,1);case"ease-in-circ":return g(.55,0,1,.45);case"ease-out-circ":return g(0,.55,.45,1);case"ease-in-out-circ":return g(.85,0,.15,1);case"ease-in-back":return g(.36,0,.66,-.56);case"ease-out-back":return g(.34,1.56,.64,1);case"ease-in-out-back":return g(.68,-.6,.32,1.6);case"step-start":return function(){return 1};case"step-end":return function(e){return e===1?1:0};default:const n="cubic-bezier(";if(r&&r.indexOf(n)===0){const e=r.substr(n.length,r.length-n.length-1).split(",");if(e.length!==4)return console.warn("Unknown timing function: "+r),function(h){return h};const t=parseFloat(e[0]||"0.42"),s=parseFloat(e[1]||"0"),i=parseFloat(e[2]||"1"),o=parseFloat(e[3]||"1");return isNaN(t)||isNaN(s)||isNaN(i)||isNaN(o)?(console.warn(" Unknown timing function: "+r),function(h){return h}):g(t,s,i,o)}else return console.warn("Unknown timing function: "+r),function(e){return e}}};Math.hypot||(Math.hypot=(...r)=>{let n=0,e=r.length;for(;e--;)n+=r[e]*r[e];return Math.sqrt(n)});const he=r=>{const n=r>>>24,e=r>>>16&255,t=r>>>8&255,s=r&255;return[n/255,e/255,t/255,s/255]};function Pe(r){return(r&255)/255}function Ne(r){const n=Math.floor(r[0]*255),e=Math.floor(r[1]*255),t=Math.floor(r[2]*255),s=Math.floor(r[3]*255);return`rgba(${n},${e},${t},${s.toFixed(4)})`}function Q(r,n,e,t,s){return s?(s.x1=r,s.y1=n,s.x2=e,s.y2=t,s):{x1:r,y1:n,x2:e,y2:t}}function De(r,n,e){const t=Q(Math.max(r.x1,n.x1),Math.max(r.y1,n.y1),Math.min(r.x2,n.x2),Math.min(r.y2,n.y2),e);return t.x1<t.x2&&t.y1<t.y2?t:Q(0,0,0,0,t)}function Fe(r,n){const e=Math.max(r.x,n.x),t=Math.max(r.y,n.y),s=Math.min(r.x+r.width,n.x+n.width)-e,i=Math.min(r.y+r.height,n.y+n.height)-t;return s>0&&i>0?{x:e,y:t,width:s,height:i}:{x:0,y:0,width:0,height:0}}function fe(r,n){return r===n?!0:r===null||n===null?!1:r.x===n.x&&r.y===n.y&&r.width===n.width&&r.height===n.height}function Ge(r){return r.x1<r.x2&&r.y1<r.y2}class le{constructor(n){a(this,"textureSource");this.textureSource=n}}class de{constructor(n){a(this,"stage");this.stage=n}}class xe{}class Te{static makeCacheKey(n){return!1}static resolveDefaults(n){return{}}}function j(r,n,e){const t=r.createShader(n);if(!t)throw new Error;if(r.shaderSource(t,e),r.compileShader(t),r.getShaderParameter(t,r.COMPILE_STATUS))return t;console.log(r.getShaderInfoLog(t)),r.deleteShader(t)}function Ee(r,n,e){const t=r.createProgram();if(!t)throw new Error;if(r.attachShader(t,n),r.attachShader(t,e),r.linkProgram(t),r.getProgramParameter(t,r.LINK_STATUS))return t;console.log(r.getProgramInfoLog(t)),r.deleteProgram(t)}function W(r){return self.WebGL2RenderingContext&&r instanceof self.WebGL2RenderingContext}class H extends Te{constructor(e){super();a(this,"boundBufferCollection",null);a(this,"buffersBound",!1);a(this,"program");a(this,"vao");a(this,"renderer");a(this,"gl");a(this,"attributeBuffers");a(this,"attributeLocations");a(this,"attributeNames");a(this,"uniformLocations");a(this,"uniformTypes");a(this,"supportsIndexedTextures");const t=this.renderer=e.renderer,s=this.gl=this.renderer.gl;this.supportsIndexedTextures=e.supportsIndexedTextures||!1;const i=W(s),o=i&&e.webgl2Extensions||!i&&e.webgl1Extensions||[],h=i?"2.0":"1.0";o.forEach(d=>{if(!s.getExtension(d))throw new Error(`Shader "${this.constructor.name}" requires extension "${d}" for WebGL ${h} but wasn't found`)});const c=e.shaderSources||this.constructor.shaderSources;if(c)i&&(c!=null&&c.webGl2)&&(c.fragment=c.webGl2.fragment,c.vertex=c.webGl2.vertex,delete c.webGl2);else throw new Error(`Shader "${this.constructor.name}" is missing shaderSources.`);const l=t.system.parameters.MAX_VERTEX_TEXTURE_IMAGE_UNITS,x=c.vertex instanceof Function?c.vertex(l):c.vertex,f=c.fragment instanceof Function?c.fragment(l):c.fragment,m=j(s,s.VERTEX_SHADER,x),E=j(s,s.FRAGMENT_SHADER,f);if(!m||!E)throw new Error;const p=Ee(s,m,E);if(!p)throw new Error;if(this.program=p,i){const d=s.createVertexArray();if(!d)throw new Error;this.vao=d,s.bindVertexArray(this.vao)}this.attributeLocations={},this.attributeBuffers={},this.attributeNames=[],[...e.attributes].forEach(d=>{const T=s.getAttribLocation(this.program,d);if(T<0)throw new Error(`${this.constructor.name}: Vertex shader must have an attribute "${d}"!`);const _=s.createBuffer();if(!_)throw new Error(`${this.constructor.name}: Could not create buffer for attribute "${d}"`);this.attributeLocations[d]=T,this.attributeBuffers[d]=_,this.attributeNames.push(d)}),this.uniformLocations={},this.uniformTypes={},e.uniforms.forEach(d=>{const T=s.getUniformLocation(this.program,d.name);if(this.uniformTypes[d.name]=d.uniform,!T){console.warn(`Shader "${this.constructor.name}" could not get uniform location for "${d.name}"`);return}this.uniformLocations[d.name]=T})}bindBufferAttribute(e,t,s){const i=this.gl;i.enableVertexAttribArray(e),i.bindBuffer(i.ARRAY_BUFFER,t),i.vertexAttribPointer(e,s.size,s.type,s.normalized,s.stride,s.offset)}disableAttribute(e){this.gl.disableVertexAttribArray(e)}disableAttributes(){for(const e in this.attributeLocations)this.disableAttribute(this.attributeLocations[e]);this.boundBufferCollection=null}canBatchShaderProps(e,t){return!1}bindRenderOp(e,t){this.bindBufferCollection(e.buffers),e.textures.length>0&&this.bindTextures(e.textures);const{gl:s}=e;if(this.setUniform("u_resolution",[s.canvas.width,s.canvas.height]),this.setUniform("u_pixelRatio",e.options.pixelRatio),t){if(X(t,"$dimensions")){let i=t.$dimensions;i||(i=e.dimensions),this.setUniform("u_dimensions",[i.width,i.height])}if(X(t,"$alpha")){let i=t.$alpha;i||(i=e.alpha),this.setUniform("u_alpha",i)}this.bindProps(t)}}setUniform(e,...t){this.gl[this.uniformTypes[e]](this.uniformLocations[e],...t)}bindBufferCollection(e){if(this.boundBufferCollection!==e){for(const t in this.attributeLocations){const s=e.getBuffer(t),i=e.getAttributeInfo(t);y(s,`Buffer for "${t}" not found`),y(i),this.bindBufferAttribute(this.attributeLocations[t],s,i)}this.boundBufferCollection=e}}bindProps(e){}bindTextures(e){}attach(){this.gl.useProgram(this.program),W(this.gl)&&this.vao&&this.gl.bindVertexArray(this.vao)}detach(){this.disableAttributes()}}a(H,"shaderSources");class _e extends xe{constructor(e,t,s,i,o,h,c,l,x,f){super();a(this,"gl");a(this,"options");a(this,"buffers");a(this,"shader");a(this,"shaderProps");a(this,"alpha");a(this,"clippingRect");a(this,"dimensions");a(this,"bufferIdx");a(this,"zIndex");a(this,"length",0);a(this,"numQuads",0);a(this,"textures",[]);a(this,"maxTextures");this.gl=e,this.options=t,this.buffers=s,this.shader=i,this.shaderProps=o,this.alpha=h,this.clippingRect=c,this.dimensions=l,this.bufferIdx=x,this.zIndex=f,this.gl=e,this.maxTextures=i.supportsIndexedTextures?e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS):1}addTexture(e){const{textures:t,maxTextures:s}=this,i=t.findIndex(h=>h===e);if(i!==-1)return i;const o=t.length;return o>=s?4294967295:(this.textures.push(e),o)}draw(){const{gl:e,shader:t,shaderProps:s,options:i}=this,{shManager:o}=i;o.useShader(t),t.bindRenderOp(this,s);const h=this.bufferIdx/24*6*2;if(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),this.clippingRect){const{x:c,y:l,width:x,height:f}=this.clippingRect,m=i.pixelRatio,E=i.canvas.height,p=Math.round(c*m),d=Math.round(x*m),T=Math.round(f*m),_=Math.round(E-T-l*m);e.enable(e.SCISSOR_TEST),e.scissor(p,_,d,T)}else e.disable(e.SCISSOR_TEST);e.drawElements(e.TRIANGLES,6*this.numQuads,e.UNSIGNED_SHORT,h)}}function pe(r){const n={MAX_RENDERBUFFER_SIZE:0,MAX_TEXTURE_SIZE:0,MAX_VIEWPORT_DIMS:0,MAX_VERTEX_TEXTURE_IMAGE_UNITS:0,MAX_TEXTURE_IMAGE_UNITS:0,MAX_COMBINED_TEXTURE_IMAGE_UNITS:0,MAX_VERTEX_ATTRIBS:0,MAX_VARYING_VECTORS:0,MAX_VERTEX_UNIFORM_VECTORS:0,MAX_FRAGMENT_UNIFORM_VECTORS:0};return Object.keys(n).forEach(t=>{n[t]=r.getParameter(r[t])}),n}function ge(r){const n={ANGLE_instanced_arrays:null,WEBGL_compressed_texture_s3tc:null,WEBGL_compressed_texture_astc:null,WEBGL_compressed_texture_etc:null,WEBGL_compressed_texture_etc1:null,WEBGL_compressed_texture_pvrtc:null,WEBKIT_WEBGL_compressed_texture_pvrtc:null,WEBGL_compressed_texture_s3tc_srgb:null,OES_vertex_array_object:null};return Object.keys(n).forEach(t=>{n[t]=r.getExtension(t)}),n}function me(r,n){if(!r)throw new Error("No WebGL context");const e=~~(n/80),t=new Uint16Array(e*6);for(let i=0,o=0;i<e;i+=6,o+=4)t[i]=o,t[i+1]=o+1,t[i+2]=o+2,t[i+3]=o+2,t[i+4]=o+1,t[i+5]=o+3;const s=r.createBuffer();r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,s),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t,r.STATIC_DRAW)}const Z=new Uint8Array([0,0,0,0]);class $ extends le{constructor(e,t){super(t);a(this,"gl");a(this,"_nativeCtxTexture",null);a(this,"_state","freed");a(this,"_w",0);a(this,"_h",0);this.gl=e}get ctxTexture(){return this._state==="freed"&&this.load(),y(this._nativeCtxTexture),this._nativeCtxTexture}get w(){return this._w}get h(){return this._h}load(){this._state==="loading"||this._state==="loaded"||(this._state="loading",this.textureSource.setState("loading"),this.onLoadRequest().then(({width:e,height:t})=>{this._state="loaded",this._w=e,this._h=t,this.textureSource.setState("loaded",{width:e,height:t})}).catch(e=>{this._state="failed",this.textureSource.setState("failed",e),console.error(e)}))}async onLoadRequest(){var o;this._nativeCtxTexture=this.createNativeCtxTexture();const{gl:e}=this;e.bindTexture(e.TEXTURE_2D,this._nativeCtxTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,this._nativeCtxTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,Z);const t=await((o=this.textureSource)==null?void 0:o.getTextureData());let s=0,i=0;if(y(this._nativeCtxTexture),t.data instanceof ImageBitmap||t.data instanceof ImageData){const h=t.data;s=h.width,i=h.height,e.bindTexture(e.TEXTURE_2D,this._nativeCtxTexture),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!t.premultiplyAlpha),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h),(W(e)||z(s)&&z(i))&&e.generateMipmap(e.TEXTURE_2D)}else t.data===null?(s=0,i=0,e.bindTexture(e.TEXTURE_2D,this._nativeCtxTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,Z)):console.error("WebGlCoreCtxTexture.onLoadRequest: Unexpected textureData returned",t);return{width:s,height:i}}free(){this._state!=="freed"&&(this._state="freed",this._w=0,this._h=0,this._nativeCtxTexture&&(this.gl.deleteTexture(this._nativeCtxTexture),this._nativeCtxTexture=null))}createNativeCtxTexture(){const e=this.gl.createTexture();if(!e)throw new Error("Could not create WebGL Texture");return e}}class V extends J{constructor(e){super();a(this,"txManager");a(this,"dimensions",null);a(this,"error",null);a(this,"state","loading");this.txManager=e}setState(e,...t){if(this.state!==e){if(this.state=e,e==="loaded"){const s=t;this.dimensions=s[0]}else if(e==="failed"){const s=t;this.error=s[0]}this.emit(e,...t)}}static makeCacheKey(e){return!1}static resolveDefaults(e){return{}}}const B=class B extends V{constructor(e,t){super(e);a(this,"props");this.props=B.resolveDefaults(t||{})}get color(){return this.props.color}set color(e){this.props.color=e}async getTextureData(){const e=new Uint32Array([this.color]),t=new Uint8ClampedArray(e.buffer);return{data:new ImageData(t,1,1),premultiplyAlpha:!0}}static makeCacheKey(e){return`ColorTexture,${B.resolveDefaults(e).color}`}static resolveDefaults(e){return{color:e.color||4294967295}}};a(B,"z$__type__Props");let Y=B;const D=class D extends V{constructor(e,t){super(e);a(this,"props");a(this,"parentTexture");a(this,"onParentTxLoaded",()=>{this.setState("loaded",{width:this.props.width,height:this.props.height})});a(this,"onParentTxFailed",(e,t)=>{this.setState("failed",t)});this.parentTexture=this.txManager.loadTexture(t.texture.txType,t.texture.props,t.texture.options),this.props=D.resolveDefaults(t||{}),queueMicrotask(()=>{const s=this.parentTexture;s.state==="loaded"?this.onParentTxLoaded(s,s.dimensions):s.state==="failed"&&this.onParentTxFailed(s,s.error),s.on("loaded",this.onParentTxLoaded),s.on("failed",this.onParentTxFailed)})}async getTextureData(){return{data:this.props}}static makeCacheKey(e){return!1}static resolveDefaults(e){return{texture:e.texture,x:e.x||0,y:e.y||0,width:e.width||0,height:e.height||0}}};a(D,"z$__type__Props");let N=D;class Re extends ${constructor(n,e){super(n,e)}async onLoadRequest(){var e,t;const n=await this.textureSource.getTextureData();return{width:((e=n.data)==null?void 0:e.width)||0,height:((t=n.data)==null?void 0:t.height)||0}}}class ye{constructor(n){a(this,"config");this.config=n}getBuffer(n){var e;return(e=this.config.find(t=>t.attributes[n]))==null?void 0:e.buffer}getAttributeInfo(n){var e;return(e=this.config.find(t=>t.attributes[n]))==null?void 0:e.attributes[n]}}const Ae=24;class Se extends de{constructor(e){super(e.stage);a(this,"gl");a(this,"system");a(this,"txManager");a(this,"shManager");a(this,"options");a(this,"quadBuffer",new ArrayBuffer(1024*1024*4));a(this,"fQuadBuffer",new Float32Array(this.quadBuffer));a(this,"uiQuadBuffer",new Uint32Array(this.quadBuffer));a(this,"renderOps",[]);a(this,"curBufferIdx",0);a(this,"curRenderOp",null);a(this,"renderables",[]);a(this,"defaultShader");a(this,"quadBufferCollection");a(this,"defaultTexture");const{canvas:t,clearColor:s,bufferMemory:i}=e;this.options=e,this.txManager=e.txManager,this.shManager=e.shManager,this.defaultTexture=new Y(this.txManager);const o=ue(t);if(!o)throw new Error("Unable to create WebGL context");this.gl=o;const h=he(s);o.viewport(0,0,t.width,t.height),o.clearColor(h[0],h[1],h[2],h[3]),me(o,i),this.system={parameters:pe(o),extensions:ge(o)},this.shManager.renderer=this,this.defaultShader=this.shManager.loadShader("DefaultShader").shader;const c=o.createBuffer();y(c);const l=6*Float32Array.BYTES_PER_ELEMENT;this.quadBufferCollection=new ye([{buffer:c,attributes:{a_position:{name:"a_position",size:2,type:o.FLOAT,normalized:!1,stride:l,offset:0},a_textureCoordinate:{name:"a_textureCoordinate",size:2,type:o.FLOAT,normalized:!1,stride:l,offset:2*Float32Array.BYTES_PER_ELEMENT},a_color:{name:"a_color",size:4,type:o.UNSIGNED_BYTE,normalized:!0,stride:l,offset:4*Float32Array.BYTES_PER_ELEMENT},a_textureIndex:{name:"a_textureIndex",size:1,type:o.FLOAT,normalized:!1,stride:l,offset:5*Float32Array.BYTES_PER_ELEMENT}}}])}reset(){this.curBufferIdx=0,this.curRenderOp=null,this.renderOps.length=0,this.gl.disable(this.gl.SCISSOR_TEST),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}getShaderManager(){return this.shManager}createCtxTexture(e){return e instanceof N?new Re(this.gl,e):new $(this.gl,e)}addQuad(e){const{fQuadBuffer:t,uiQuadBuffer:s}=this,{width:i,height:o,colorTl:h,colorTr:c,colorBl:l,colorBr:x,textureOptions:f,shader:m,shaderProps:E,alpha:p,clippingRect:d,tx:T,ty:_,ta:F,tb:G,tc:v,td:U}=e;let{texture:A}=e;if(E&&X(E,"$dimensions")){const C=E.$dimensions;C.width=i,C.height=o}A=A??this.defaultTexture,y(A instanceof V,"Invalid texture type");let{curBufferIdx:u,curRenderOp:R}=this;const te={width:i,height:o},L=m||this.defaultShader;y(L instanceof H),R&&(R.shader!==L||!fe(R.clippingRect,d)||R.shader!==this.defaultShader&&(!E||!R.shader.canBatchShaderProps(R.shaderProps,E)))&&(R=null),y(L instanceof H),R||(this.newRenderOp(L,E,p,te,d,u),R=this.curRenderOp,y(R));const re=(f==null?void 0:f.flipX)??!1,se=(f==null?void 0:f.flipY)??!1;let S=0,b=0,w=1,M=1;if(A instanceof N){const{x:C,y:O,width:ie,height:oe}=A.props,{width:K=0,height:q=0}=A.parentTexture.dimensions||{width:0,height:0};S=C/K,w=S+ie/K,b=O/q,M=b+oe/q,A=A.parentTexture}re&&([S,w]=[w,S]),se&&([b,M]=[M,b]);const{txManager:ne}=this.stage,k=ne.getCtxTexture(A);y(k instanceof $);const I=this.addTexture(k,u);if(R=this.curRenderOp,y(R),G!==0||v!==0)t[u++]=T,t[u++]=_,t[u++]=S,t[u++]=b,s[u++]=h,t[u++]=I,t[u++]=T+i*F,t[u++]=_+i*v,t[u++]=w,t[u++]=b,s[u++]=c,t[u++]=I,t[u++]=T+o*G,t[u++]=_+o*U,t[u++]=S,t[u++]=M,s[u++]=l,t[u++]=I,t[u++]=T+i*F+o*G,t[u++]=_+i*v+o*U,t[u++]=w,t[u++]=M,s[u++]=x,t[u++]=I;else{const C=T+i*F,O=_+o*U;t[u++]=T,t[u++]=_,t[u++]=S,t[u++]=b,s[u++]=h,t[u++]=I,t[u++]=C,t[u++]=_,t[u++]=w,t[u++]=b,s[u++]=c,t[u++]=I,t[u++]=T,t[u++]=O,t[u++]=S,t[u++]=M,s[u++]=l,t[u++]=I,t[u++]=C,t[u++]=O,t[u++]=w,t[u++]=M,s[u++]=x,t[u++]=I}R.length+=Ae,R.numQuads++,this.curBufferIdx=u}newRenderOp(e,t,s,i,o,h){const c=new _e(this.gl,this.options,this.quadBufferCollection,e,t,s,o,i,h,0);this.curRenderOp=c,this.renderOps.push(c)}addTexture(e,t,s){const{curRenderOp:i}=this;y(i);const o=i.addTexture(e);if(o===4294967295){if(s)throw new Error("Unable to add texture to render op");const{shader:h,shaderProps:c,dimensions:l,clippingRect:x,alpha:f}=i;return this.newRenderOp(h,c,f,l,x,t),this.addTexture(e,t,!0)}return o}addRenderOp(e){this.renderOps.push(e),this.curRenderOp=null}render(e="screen"){const{gl:t,quadBuffer:s}=this,i=new Float32Array(s,0,this.curBufferIdx),o=this.quadBufferCollection.getBuffer("a_position")??null;t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,i,t.DYNAMIC_DRAW),this.renderOps.forEach((h,c)=>{h.draw()}),this.renderables=[]}}class ee extends J{constructor(e,t){super();a(this,"fontFamily");a(this,"descriptors");a(this,"loaded",!1);this.fontFamily=e,this.descriptors={style:"normal",weight:"normal",stretch:"normal",...t}}static convertToCssFontFaceDescriptors(e){return{style:e.style,weight:typeof e.weight=="number"?`${e.weight}`:e.weight,stretch:e.stretch,unicodeRange:e.unicodeRange,variant:e.variant,featureSettings:e.featureSettings,display:e.display}}}const be={LINE_FEED:10,CARRIAGE_RETURN:13,SPACE:32,TAB:9,ZERO_WIDTH_SPACE:8203,ZERO_WIDTH_NON_JOINER:8204,ZERO_WIDTH_JOINER:8205,LEFT_TO_RIGHT_MARK:8206,RIGHT_TO_LEFT_MARK:8207,LEFT_TO_RIGHT_EMBEDDING:8234,RIGHT_TO_LEFT_EMBEDDING:8235,POP_DIRECTIONAL_FORMATTING:8236,LEFT_TO_RIGHT_OVERRIDE:8237,RIGHT_TO_LEFT_OVERRIDE:8238,LINE_SEPARATOR:8232,PARAGRAPH_SEPARATOR:8233,OBJECT_REPLACEMENT_CHARACTER:65532,REPLACEMENT_CHARACTER:65533,ZERO_WIDTH_NO_BREAK_SPACE:65279,LEFT_TO_RIGHT_ISOLATE:8294,RIGHT_TO_LEFT_ISOLATE:8295,FIRST_STRONG_ISOLATE:8296,POP_DIRECTIONAL_ISOLATE:8297,INHIBIT_SYMMETRIC_SWAPPING:8298,ACTIVATE_SYMMETRIC_SWAPPING:8299,INHIBIT_ARABIC_FORM_SHAPING:8300,ACTIVATE_ARABIC_FORM_SHAPING:8301,NATIONAL_DIGIT_SHAPES:8302,NOMINAL_DIGIT_SHAPES:8303,LEFT_TO_RIGHT_BOUNDARY:8206,RIGHT_TO_LEFT_BOUNDARY:8207};class Ie{}class we extends Ie{constructor(e){super();a(this,"data");a(this,"kernings");this.data=e;const t=this.kernings={};e.kernings.forEach(s=>{const i=s.second,o=t[i]=t[i]||{};o[s.first]=s.amount}),this.kernings=t}*shapeText(e,t){var o;let s,i;for(;(s=t.peek())&&!s.done;){const h=s.value,c=this.data.chars.find(l=>l.id===h);if(t.next(),c!==void 0){const l=i!==void 0?(((o=this.kernings[c.id])==null?void 0:o[i])||0)+e.letterSpacing:0;i=c.id,yield{mapped:!0,glyphId:c.id,codepoint:h,cluster:t.lastIndex,xAdvance:c.xadvance+l,yAdvance:0,xOffset:c.xoffset+l,yOffset:c.yoffset,xBearing:0,yBearing:0,width:c.width,height:c.height}}else h===be.LINE_FEED&&(i=void 0),yield{mapped:!1,codepoint:h,cluster:t.lastIndex}}}}class ve extends ee{constructor(e,t,s,i,o,h){super(e,t);a(this,"type");a(this,"texture");a(this,"data");a(this,"shaper");a(this,"glyphMap",new Map);this.type=s;const c=i.renderer;y(c instanceof Se,"SDF Font Faces can only be used with the WebGL Renderer"),this.texture=i.txManager.loadTexture("ImageTexture",{src:o,premultiplyAlpha:!1},{preload:!0}),this.texture.on("loaded",()=>{this.checkLoaded()}),fetch(h).then(async l=>{this.data=await l.json(),this.shaper=new we(this.data),this.data.chars.forEach(x=>{this.glyphMap.set(x.id,x)}),this.checkLoaded()}).catch(console.error)}getAtlasEntry(e){const t=this.glyphMap.get(e);if(t===void 0)throw new Error(`Glyph ${e} not found in font ${this.fontFamily}`);return{x:t.x,y:t.y,width:t.width,height:t.height}}checkLoaded(){this.loaded||this.texture.state==="loaded"&&this.data&&(this.loaded=!0,this.emit("loaded"))}}class Ue extends ee{constructor(e,t,s){super(e,t);a(this,"fontFace");a(this,"fontUrl");const i=s.replace(/\(|\)/g,""),o=this.descriptors,h={style:o.style,weight:typeof o.weight=="number"?`${o.weight}`:o.weight,stretch:o.stretch,unicodeRange:o.unicodeRange,variant:o.variant,featureSettings:o.featureSettings,display:o.display},c=new FontFace(e,`url(${i})`,h);c.load().then(()=>{this.loaded=!0,this.emit("loaded")}).catch(console.error),this.fontFace=c,this.fontUrl=s}}class Xe{}const We={[P.settings]:{},get(r,n=null){return r in this[P.settings]?this[P.settings][r]:n},set(r,n){typeof r=="object"?Object.keys(r).forEach(e=>{this.set(e,r[e])}):this[P.settings][r]=n}};export{ye as B,Y as C,J as E,N as S,V as T,H as W,y as a,Le as b,he as c,Ge as d,Q as e,ve as f,Oe as g,De as h,Fe as i,_e as j,Be as k,Ne as l,Ce as m,Ue as n,Pe as o,Se as p,Xe as q,We as r,P as s};
